<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{INJECT_PAGE_TITLE}}</title>
    <link rel="stylesheet" href="https://unpkg.com/picnic">
    <link rel="icon" type="image/png" sizes="32x32" href="{{INJECT_FAVICON}}">
    <style>
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --background-gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --form-bg-color: #f7f7f7;
            --text-color: #333;
            --menu-bg-color: #0d1a26;
            --menu-text-color: #fff;
            --menu-link-color: #fff;
            --focus-color: #55aaff;
            --border-radius: 8px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-height: 100vh;
            background: var(--background-gradient);
            color: var(--menu-text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 90%;
            max-width: 450px;
            margin: 1vh auto 20px;
            padding: 2rem;
            background: var(--form-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            color: var(--text-color);
            text-align: center;
        }

        h1#message {
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 600;
        }

        /* Form Styling */
        form#signForm {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 2rem;
        }
        form#signForm.hidden {
          display: none;
        }


        input#nameInput,
        button#submitButton {
            padding: 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease-in-out;
        }

        input#nameInput:focus {
            outline: none;
            border-color: var(--focus-color);
            box-shadow: 0 0 0 3px rgba(85, 170, 255, 0.3);
        }

        button#submitButton {
            cursor: pointer;
            background: var(--primary-color);
            color: var(--menu-text-color);
            border: none;
            font-weight: bold;
            text-transform: uppercase;
        }

        button#submitButton:hover,
        button#submitButton:focus {
            background: var(--secondary-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        button#clearName {
            margin-top: -1rem;
            background: none;
            border: none;
            color: #888;
            font-size: 0.8rem;
            text-decoration: underline;
            cursor: pointer;
            text-align: right;
            transition: color 0.2s;
        }

        button#clearName:hover {
            color: var(--text-color);
        }

        .hidden {
            display: none;
        }
        
        /* Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Dropdown */
        .dropdown {
            position: absolute;
            background: #fff;
            color: var(--text-color);
            list-style: none;
            padding: 0;
            margin-top: 3rem;
            border: 1px solid #ccc;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            text-align: left;
        }

        .dropdown-item:hover,
        .dropdown-item.active {
            background: var(--primary-color);
            color: #fff;
        }

        .highlight {
            font-weight: bold;
            color: var(--primary-color);
        }

        .dropdown-item:hover .highlight {
            color: #fff;
        }

        /* Header Styles */
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--menu-bg-color);
            color: var(--menu-text-color);
            padding: 12px 1rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
        }

        .menu-header a {
            color: var(--menu-link-color);
            text-decoration: none;
            transition: color 0.2s ease-in-out;
        }
        
        .menu-header a:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        .menu-left,
        .menu-center,
        .menu-right {
            flex: 1;
            padding: 0 0.5rem;
            white-space: nowrap; /* Prevents wrapping for short strings */
        }
        
        .menu-left {
            text-align: left;
        }
        
        .menu-center {
            text-align: center;
        }
        
        .menu-right {
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="header-container"></div>
        <h1 id="message"></h1>
        <form id="signForm" class="hidden">
            <input type="text" id="nameInput" placeholder="Enter your name" autocomplete="off">
            <button type="button" id="clearName">Clear Name</button>
            <input type="hidden" id="activityId" value="sorrento_youth_sunday">
            <input type="hidden" id="direction">
            <input type="hidden" id="nameId">
            <button type="submit" id="submitButton"></button>
        </form>
        <div id="spinner" class="spinner hidden"></div>
    </div>
    <script>
        const API_BASE = "{{INJECT_API_URL}}";
        const ACTIVITY_ID = "{{INJECT_ACTIVITY_ID}}";
        let IN_START_TIME = convertTimeStringToDateObj("08:00");
        let OUT_START_TIME = convertTimeStringToDateObj("09:30");
        let END_TIME = convertTimeStringToDateObj("10:40");

        const messageEl = document.getElementById("message");
        const formEl = document.getElementById("signForm");
        const spinnerEl = document.getElementById("spinner");
        const nameInput = document.getElementById("nameInput");
        const clearNameButton = document.getElementById("clearName");
        const directionInput = document.getElementById("direction");
        const nameIdInput = document.getElementById("nameId");
        const submitButton = document.getElementById("submitButton");

        // inject ./header.snippet
        fetch('./header.snippet')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
            })
            .catch(error => console.error('Header load error:', error));

        // Utility to convert human readable time strings to date object.
        function convertTimeStringToDateObj(timeString) {
            const [hours, minutes] = timeString.split(":").map(Number);
            const now = new Date();
            now.setHours(hours, minutes, 0, 0);
            return now;
        }

        // Utility to parse URL parameters
        function getUrlParameter(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // Utility to check if today is Sunday
        function isSunday() {
            const enableTestMode = {{INJECT_ENABLE_TEST_MODE}};
            if (enableTestMode) {
                return true;  // For testing purposes, always return true
            } else {
                return new Date().getDay() === 0;
            }
        }

        // Utility to calculate the next Sunday
        function getNextSunday() {
            const now = new Date();
            let daysUntilSunday = (7 - now.getDay()) % 7;
            // if today is sunday, then it will be 7 days to next sunday.
            daysUntilSunday = daysUntilSunday === 0 ? 7 : daysUntilSunday;
            const nextSunday = new Date(now);
            nextSunday.setDate(now.getDate() + daysUntilSunday);
            return nextSunday.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
        }

        // Fetch valid names from the backend
        async function fetchNames() {
            const response = await fetch(`${API_BASE}/name?activity_id=${ACTIVITY_ID}`);
            return response.json();
        }

        // Add log entry to the backend
        async function addLog(nameId, direction) {
            const payload = {
                activity_id: ACTIVITY_ID,
                name_id: nameId,
                direction: direction,
                date_time: new Date().toISOString()
            };

            const response = await fetch(`${API_BASE}/log`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            return response.json();
        }

        // Initialize the page
        function init() {
            const now = new Date();
            const enableTestMode = {{INJECT_ENABLE_TEST_MODE}};
            if (enableTestMode) {
                const testParam = getUrlParameter("test");

                if (testParam === "in") {
                    IN_START_TIME = new Date(now.getTime() - 10 * 60 * 1000); // Override IN_START_TIME with current time - 10minutes
                    OUT_START_TIME = new Date(now.getTime() + 10 * 60 * 1000); // Override OUT_START_TIME with current time + 10 minutes
                    END_TIME = new Date(now.getTime() + 20 * 60 * 1000); // Override END_TIME with current time + 20minutes
                }
                if (testParam === "out") {
                    IN_START_TIME = new Date(now.getTime() - 20 * 60 * 1000); // Override IN_START_TIME with current time - 10minutes
                    OUT_START_TIME = new Date(now.getTime() - 10 * 60 * 1000); // Override OUT_START_TIME with current time + 10 minutes
                    END_TIME = new Date(now.getTime() + 20 * 60 * 1000); // Override END_TIME with current time + 20minutes
                }
            }

            if (!isSunday() || now > END_TIME) {
                messageEl.textContent = `The next session is ${getNextSunday()}`;
                return;
            }

            if (now < IN_START_TIME) {
                messageEl.textContent = `Sign in starts at ${IN_START_TIME}`;
                return;
            }

            if (now >= IN_START_TIME && now < OUT_START_TIME) {
                setupForm("in");
                return;
            }

            if (now >= OUT_START_TIME && now < END_TIME) {
                setupForm("out");
                return;
            }
        }

        // Setup the form for sign-in or sign-out
        async function setupForm(direction) {
            //messageEl.textContent = direction === "in" ? "Sign In" : "Sign Out";
            messageEl.textContent = "";  // don't display a message, button text is enough
            submitButton.textContent = direction === "in" ? "Sign In" : "Sign Out";
            formEl.classList.remove("hidden");
            directionInput.value = direction;

            const savedName = localStorage.getItem("name");
            if (savedName) {
                nameInput.value = savedName;
            }

            const dropdown = document.createElement("ul");
            dropdown.classList.add("dropdown", "hidden");
            formEl.appendChild(dropdown);

            const names = (await fetchNames()).names || [];

            // Debounce function to limit filtering frequency
            function debounce(func, delay) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), delay);
                };
            }

            // Filter and display matching names
            function filterNames() {
                const inputValue = nameInput.value.toLowerCase();
                const matches = names.filter(name => name.display.toLowerCase().includes(inputValue));

                dropdown.innerHTML = ""; // Clear previous suggestions
                if (matches.length > 0 && inputValue) {
                    matches.forEach((match, index) => {
                        const item = document.createElement("li");
                        item.classList.add("dropdown-item");
                        item.innerHTML = match.display.replace(
                            new RegExp(inputValue, "gi"),
                            match => `<span class="highlight">${match}</span>`
                        );

                        item.addEventListener("click", () => {
                            nameInput.value = match.display;
                            nameIdInput.value = match.name_id;
                            dropdown.classList.add("hidden");
                        });

                        dropdown.appendChild(item);
                    });
                    dropdown.classList.remove("hidden");
                } else {
                    dropdown.classList.add("hidden");
                }
            }

            // Add event listeners
            nameInput.addEventListener("input", debounce(filterNames, 300));
            nameInput.addEventListener("blur", () => {
                setTimeout(() => dropdown.classList.add("hidden"), 200);
            });
            nameInput.addEventListener("focus", () => {
                if (dropdown.children.length > 0) {
                    dropdown.classList.remove("hidden");
                }
            });

            // Keyboard navigation
            nameInput.addEventListener("keydown", (e) => {
                const items = dropdown.querySelectorAll(".dropdown-item");
                let activeIndex = Array.from(items).findIndex(item => item.classList.contains("active"));

                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    if (activeIndex < items.length - 1) {
                        if (activeIndex >= 0) items[activeIndex].classList.remove("active");
                        items[++activeIndex].classList.add("active");
                    }
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    if (activeIndex > 0) {
                        items[activeIndex].classList.remove("active");
                        items[--activeIndex].classList.add("active");
                    }
                } else if (e.key === "Enter" && activeIndex >= 0) {
                    e.preventDefault();
                    items[activeIndex].click();
                }
            });
        }

        // Handle form submission
        formEl.addEventListener("submit", async (e) => {
            e.preventDefault();
            spinnerEl.classList.remove("hidden");

            const nameId = nameIdInput.value;
            const direction = directionInput.value;

            try {
                const result = await addLog(nameId, direction);
                //alert(result.message || "Success!");
                messageEl.textContent = "You have signed " + direction;
                localStorage.setItem("name", nameInput.value);
            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                spinnerEl.classList.add("hidden");
            }
        });

        // Clear saved name
        clearNameButton.addEventListener("click", () => {
            localStorage.removeItem("name");
            messageEl.textContent = "";
            nameInput.value = "";
        });

        // Initialize the page on load
        init();
    </script>
</body>
</html>