<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bulk sign-in-out</title>
    <link rel="stylesheet" href="https://unpkg.com/picnic">
    <link rel="stylesheet" href="./sign-in-out.css">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-test.png">
</head>
<body>
    <div id="header-container"></div>
    <div class="container">
        <h1 id="message"></h1>
        <div class="buttons" id="filterButtons"></div>
        <form id="bulkForm" class="hidden">
            <input type="hidden" id="direction">
            <input type="hidden" id="activity_id" value="sorrento_youth_sunday">
            <table id="namesTable">
                <thead> <tr> <th>name</th> <th>in</th> <th>out</th> </tr> </thead>
                <tbody></tbody>
            </table>
            <button type="submit" id="bulkSubmitButton"></button>
        </form>
        <div id="spinner" class="spinner hidden"></div>
    </div>
    <script>
        const API_BASE = "https://5eifrv56p8.execute-api.ap-southeast-2.amazonaws.com";
        const ACTIVITY_ID = "sorrento_youth_sunday";
        let IN_START_TIME = convertTimeStringToDateObj("08:00");
        let OUT_START_TIME = convertTimeStringToDateObj("09:30");
        let END_TIME = convertTimeStringToDateObj("10:40");
        let LOG_DATE_STRING = new Date().toISOString().split('T')[0]; // Default to today

        const messageEl = document.getElementById("message");
        const formEl = document.getElementById("bulkForm");
        const spinnerEl = document.getElementById("spinner");
        const directionInputEl = document.getElementById("direction");
        const activityInputEl = document.getElementById("activity_id");
        const submitButton = document.getElementById("bulkSubmitButton");

        let names = [];
        let logs = [];

        // inject ./header_leader.snippet
        fetch('./header_leader.snippet')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
            })
            .catch(error => console.error('Header load error:', error));

        // Utility to convert human readable time strings to date object.
        function convertTimeStringToDateObj(timeString) {
            const [hours, minutes] = timeString.split(":").map(Number);
            const now = new Date();
            now.setHours(hours, minutes, 0, 0);
            return now;
        }

        // convert timestamp string to HH:MM format
        function convertTs2Time(timestamp) {
            if (!timestamp || timestamp === "-") return "-";
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Utility to parse URL parameters
        function getUrlParameter(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // Utility to check if today is Sunday
        function isSunday() {
            const enableTestMode = true;
            if (enableTestMode) {
                return true;  // For testing purposes, always return true
            } else {
                return new Date().getDay() === 0;
            }
        }

        // Utility to calculate the next Sunday
        function getNextSunday() {
            const now = new Date();
            let daysUntilSunday = (7 - now.getDay()) % 7;
            // if today is sunday, then it will be 7 days to next sunday.
            daysUntilSunday = daysUntilSunday === 0 ? 7 : daysUntilSunday;
            const nextSunday = new Date(now);
            nextSunday.setDate(now.getDate() + daysUntilSunday);
            return nextSunday.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
        }

        // Fetch names from the backend and populate global array
        async function fetchNames() {
            const response = await fetch(`${API_BASE}/name?activity_id=${ACTIVITY_ID}`);
            const data = await response.json();
            names = data.names || [];
        }

        // Fetch logs from the backend
        async function fetchLogs() {
            const response = await fetch(`${API_BASE}/log?activity_id=${ACTIVITY_ID}&date=${LOG_DATE_STRING}`);
            const data = await response.json();
            logs = data.logs || [];
        }

        // Add bulk log entries to the backend
        async function addBulkLogs(payload) {

            const response = await fetch(`${API_BASE}/bulk`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            return response.json();
        }

        // Initialize the page
        async function init() {
            const now = new Date();
            const enableTestMode = true;
            if (enableTestMode) {
                const testParam = getUrlParameter("test");

                if (testParam === "in") {
                    IN_START_TIME = new Date(now.getTime() - 10 * 60 * 1000); // Override IN_START_TIME with current time - 10minutes
                    OUT_START_TIME = new Date(now.getTime() + 10 * 60 * 1000); // Override OUT_START_TIME with current time + 10 minutes
                    END_TIME = new Date(now.getTime() + 20 * 60 * 1000); // Override END_TIME with current time + 20minutes
                }
                if (testParam === "out") {
                    IN_START_TIME = new Date(now.getTime() - 20 * 60 * 1000); // Override IN_START_TIME with current time - 10minutes
                    OUT_START_TIME = new Date(now.getTime() - 10 * 60 * 1000); // Override OUT_START_TIME with current time + 10 minutes
                    END_TIME = new Date(now.getTime() + 20 * 60 * 1000); // Override END_TIME with current time + 20minutes
                }
            }

            if (!isSunday() || now > END_TIME) {
                messageEl.textContent = `The next session is ${getNextSunday()}`;
                return;
            }

            if (now < IN_START_TIME) {
                messageEl.textContent = `Sign in starts at ${IN_START_TIME}`;
                return;
            }

            let verified_direction = "in";
            if (now >= OUT_START_TIME && now < END_TIME) {
                verified_direction = "out";
            }

            messageEl.textContent = `Select a group for bulk sign-${verified_direction}`;
            await fetchNames(); //populates global names[]
            await fetchLogs();  //populates global logs[]
            renderFilterButtons();
            setupBulkForm(verified_direction);
            return;
        }

        // Render filter buttons
        function renderFilterButtons() {
            const filters = Array.from(new Set(names.map(name => name.filter))).sort();
            const buttonsContainer = document.getElementById("filterButtons");
            buttonsContainer.innerHTML = "";

            // Add "all" button
            const allButton = document.createElement("button");
            allButton.textContent = "All";
            allButton.onclick = () => filterTable("all");
            buttonsContainer.appendChild(allButton);

            // Add filter-specific buttons
            filters.forEach(filter => {
                const button = document.createElement("button");
                button.textContent = filter;
                button.onclick = () => filterTable(filter);
                buttonsContainer.appendChild(button);
            });
        }

        // Filter table based on filter value
        function filterTable(filter) {
            const allRows = document.querySelectorAll("[class^='filter-']");
            messageEl.textContent = filter;
            allRows.forEach(row => row.classList.remove("hidden"));

            if (filter !== "all") {
                allRows.forEach(row => {
                    if (!row.classList.contains(`filter-${filter}`)) {
                        row.classList.add("hidden");
                    }
                });
            }
        }

        // Setup the form for BULK sign-in or sign-out
        async function setupBulkForm(direction) {
            submitButton.disabled = false; // (re-)enable button
            submitButton.textContent = direction === "in" ? "Bulk Sign In" : "Bulk Sign Out";
            formEl.classList.remove("hidden");
            directionInputEl.value = direction;

            const tbody = document.querySelector("#namesTable tbody");
            tbody.innerHTML = "";
          
            names.forEach(name => {
                const name_id = name.name_id;
                const row = document.createElement("tr");
                row.classList.add(`filter-${name.filter || "no-filter"}`);  // this enables filter buttons
            
                // Column 1: Display name & hidden input for name_id
                const nameCell = document.createElement("td");
                nameCell.textContent = name.display;
  
                const hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.value = name_id;
                hiddenInput.classList.add("name-id");
                nameCell.appendChild(hiddenInput);
                row.appendChild(nameCell);

                // Column 2: In  [time if in-log found / checkbox if direction=in / - if direction=out] 
                const inCell = document.createElement("td");
                const matchIn = logs.find(
                    log => log.name_id === name_id && log.direction === "in"
                );

                if (matchIn) {
                    inCell.textContent = convertTs2Time(matchIn.date_time);
                } else if (direction === "in") {
                    const toggle = document.createElement("input");
                    toggle.type = "checkbox";
                    toggle.classList.add("name-toggle");
                    toggle.dataset.nameId = name.name_id;
                    inCell.appendChild(toggle);
                } else {
                    inCell.textContent = "-";
                }
                row.appendChild(inCell);

                // Column 3: Out  [time if out-log found / checkbox if direction=out AND matchIn / - if direction=in] 
                const outCell = document.createElement("td");
                const matchOut = logs.find(
                    log => log.name_id === name.name_id && log.direction === "out"
                );

                if (matchOut) {
                    outCell.textContent = convertTs2Time(matchOut.date_time);
                } else if (direction === "out") {
                    if (matchIn) {
                        const toggle = document.createElement("input");
                        toggle.type = "checkbox";
                        toggle.classList.add("name-toggle");
                        toggle.dataset.nameId = name.name_id;
                        outCell.appendChild(toggle);
                    } else {
                        outCell.textContent = "-";
                    }
                } else {
                  outCell.textContent = "-";
                }
                row.appendChild(outCell);

                // Initially hide all rows; they will be shown when a filter button is clicked
                row.classList.add("hidden");

                tbody.appendChild(row);
            });
        }

        // Handle form submission
        formEl.addEventListener("submit", async (e) => {
            e.preventDefault();
            spinnerEl.classList.remove("hidden");

            const direction = directionInputEl.value;
            const activity_id = activityInputEl.value;
            const toggles = document.querySelectorAll(".name-toggle");
            const listOfNameId = [];

            toggles.forEach(toggle => {
              if (toggle.checked) {
                listOfNameId.push(toggle.dataset.nameId);
              }
            });

            if (listOfNameId.length === 0) {
              messageEl.textContent = "No names selected for submission"; 
              spinnerEl.classList.add("hidden");
              window.scrollTo({ top: 0, behavior: 'smooth' });
              return;
            }

            try {
              await addBulkLogs({
                activity_id: activity_id,
                direction: direction,
                name_id_list: listOfNameId,
                date_time: new Date().toISOString()
              });

              messageEl.textContent = "Bulk Submission Completed";
              submitButton.disabled = true;
            } catch (error) {
              alert("Error: " + error.message);
            } finally {
              spinnerEl.classList.add("hidden");
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Initialize the page on load
        (async () => { await init(); })();
    </script>
</body>
</html>